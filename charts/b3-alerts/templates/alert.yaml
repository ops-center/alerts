{{ $app := (include "b3-alerts.fullname" .) }}
{{ $job := .Values.grafana.jobName }}

{{ if (include "b3-alerts.alertsEnabled" .Values.form.alert.enabled) }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ $app }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "b3-alerts.labels" . | nindent 4 }}
{{- if .Values.form.alert.labels }}
    {{- toYaml .Values.form.alert.labels | nindent 4 }}
{{- end }}
{{- if .Values.form.alert.annotations }}
  annotations:
    {{- toYaml .Values.form.alert.annotations | nindent 4 }}
{{- end }}
spec:
  groups:
  # ===========================================
  # Process & Runtime Alerts
  # ===========================================
{{- with .Values.form.alert.groups.process }}
{{- if (include "b3-alerts.alertGroupEnabled" (list $.Values.form.alert.enabled .)) }}
  - name: b3.process.{{ $.Release.Namespace }}.{{ $app }}.rules
    rules:
{{- if (include "b3-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.b3ProcessRestarted.enabled .rules.b3ProcessRestarted.severity)) }}
    - alert: B3ProcessRestarted
      expr: changes(process_start_time_seconds{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"}[10m]) > 0
      for: {{ .rules.b3ProcessRestarted.duration }}
      labels:
        severity: {{ .rules.b3ProcessRestarted.severity }}
        {{- include "b3-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: "B3 process restarted (instance {{`{{`}} $labels.pod {{`}}`}})"
        description: "B3 process on pod {{`{{`}} $labels.pod {{`}}`}} has restarted in the last 10 minutes.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
{{- end }}
{{- if (include "b3-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.b3HighGoroutineCount.enabled .rules.b3HighGoroutineCount.severity)) }}
    - alert: B3HighGoroutineCount
      expr: go_goroutines{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"} > {{ .rules.b3HighGoroutineCount.val }}
      for: {{ .rules.b3HighGoroutineCount.duration }}
      labels:
        severity: {{ .rules.b3HighGoroutineCount.severity }}
        {{- include "b3-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: "B3 high goroutine count (instance {{`{{`}} $labels.pod {{`}}`}})"
        description: "B3 pod {{`{{`}} $labels.pod {{`}}`}} has {{`{{`}} $value {{`}}`}} goroutines, exceeding {{ .rules.b3HighGoroutineCount.val }} threshold. Possible goroutine leak.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
{{- end }}
{{- if (include "b3-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.b3HighGcPauseDuration.enabled .rules.b3HighGcPauseDuration.severity)) }}
    - alert: B3HighGcPauseDuration
      expr: max(go_gc_duration_seconds{job="{{ $job }}",namespace="{{ $.Release.Namespace }}",quantile=~"1|1.0"}) > {{ .rules.b3HighGcPauseDuration.val }}
      for: {{ .rules.b3HighGcPauseDuration.duration }}
      labels:
        severity: {{ .rules.b3HighGcPauseDuration.severity }}
        {{- include "b3-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: "B3 high GC pause duration (instance {{`{{`}} $labels.pod {{`}}`}})"
        description: "B3 pod {{`{{`}} $labels.pod {{`}}`}} GC pause duration is {{`{{`}} $value | printf \"%.3f\" {{`}}`}}s, exceeding {{ .rules.b3HighGcPauseDuration.val }}s threshold.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
{{- end }}
{{- if (include "b3-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.b3HighFileDescriptorUsage.enabled .rules.b3HighFileDescriptorUsage.severity)) }}
    - alert: B3HighFileDescriptorUsage
      expr: (process_open_fds{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"} / process_max_fds{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"}) * 100 > {{ .rules.b3HighFileDescriptorUsage.val }}
      for: {{ .rules.b3HighFileDescriptorUsage.duration }}
      labels:
        severity: {{ .rules.b3HighFileDescriptorUsage.severity }}
        {{- include "b3-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: "B3 high file descriptor usage (instance {{`{{`}} $labels.pod {{`}}`}})"
        description: "B3 pod {{`{{`}} $labels.pod {{`}}`}} is using {{`{{`}} $value | printf \"%.2f\" {{`}}`}}% of available file descriptors.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
{{- end }}
{{- if (include "b3-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.b3MemoryLeak.enabled .rules.b3MemoryLeak.severity)) }}
    - alert: B3MemoryLeak
      expr: deriv(process_resident_memory_bytes{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"}[2h]) > {{ .rules.b3MemoryLeak.val }}
      for: {{ .rules.b3MemoryLeak.duration }}
      labels:
        severity: {{ .rules.b3MemoryLeak.severity }}
        {{- include "b3-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: "B3 possible memory leak (instance {{`{{`}} $labels.pod {{`}}`}})"
        description: "B3 pod {{`{{`}} $labels.pod {{`}}`}} memory has been steadily increasing at {{`{{`}} $value | humanize {{`}}`}}B/s for over {{ .rules.b3MemoryLeak.duration }}. Possible memory leak.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
{{- end }}
{{- if (include "b3-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.b3CpuRunaway.enabled .rules.b3CpuRunaway.severity)) }}
    - alert: B3CpuRunaway
      expr: deriv(rate(process_cpu_seconds_total{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"}[5m])[2h:1m]) > {{ .rules.b3CpuRunaway.val }}
      for: {{ .rules.b3CpuRunaway.duration }}
      labels:
        severity: {{ .rules.b3CpuRunaway.severity }}
        {{- include "b3-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: "B3 possible CPU runaway (instance {{`{{`}} $labels.pod {{`}}`}})"
        description: "B3 pod {{`{{`}} $labels.pod {{`}}`}} CPU usage has been steadily increasing for over {{ .rules.b3CpuRunaway.duration }}. Possible runaway process or infinite loop.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
{{- end }}
{{- if (include "b3-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.b3GoroutineLeak.enabled .rules.b3GoroutineLeak.severity)) }}
    - alert: B3GoroutineLeak
      expr: deriv(go_goroutines{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"}[2h]) > {{ .rules.b3GoroutineLeak.val }}
      for: {{ .rules.b3GoroutineLeak.duration }}
      labels:
        severity: {{ .rules.b3GoroutineLeak.severity }}
        {{- include "b3-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: "B3 possible goroutine leak (instance {{`{{`}} $labels.pod {{`}}`}})"
        description: "B3 pod {{`{{`}} $labels.pod {{`}}`}} goroutine count has been steadily increasing at {{`{{`}} $value | printf \"%.2f\" {{`}}`}} goroutines/sec for over {{ .rules.b3GoroutineLeak.duration }}. Possible goroutine leak.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
{{- end }}
{{- if (include "b3-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.b3MemorySpike.enabled .rules.b3MemorySpike.severity)) }}
    - alert: B3MemorySpike
      expr: increase(process_resident_memory_bytes{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"}[10m]) > {{ .rules.b3MemorySpike.val }}
      for: {{ .rules.b3MemorySpike.duration }}
      labels:
        severity: {{ .rules.b3MemorySpike.severity }}
        {{- include "b3-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: "B3 memory spike (instance {{`{{`}} $labels.pod {{`}}`}})"
        description: "B3 pod {{`{{`}} $labels.pod {{`}}`}} memory increased by {{`{{`}} $value | humanize {{`}}`}}B in the last 10 minutes.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
{{- end }}
{{- if (include "b3-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.b3CpuSpike.enabled .rules.b3CpuSpike.severity)) }}
    - alert: B3CpuSpike
      expr: rate(process_cpu_seconds_total{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"}[5m]) > {{ .rules.b3CpuSpike.val }}
      for: {{ .rules.b3CpuSpike.duration }}
      labels:
        severity: {{ .rules.b3CpuSpike.severity }}
        {{- include "b3-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: "B3 CPU spike (instance {{`{{`}} $labels.pod {{`}}`}})"
        description: "B3 pod {{`{{`}} $labels.pod {{`}}`}} is using {{`{{`}} $value | printf \"%.2f\" {{`}}`}} CPU cores, exceeding {{ .rules.b3CpuSpike.val }} threshold.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
{{- end }}
{{- if (include "b3-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.b3GoroutineSpike.enabled .rules.b3GoroutineSpike.severity)) }}
    - alert: B3GoroutineSpike
      expr: increase(go_goroutines{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"}[10m]) > {{ .rules.b3GoroutineSpike.val }}
      for: {{ .rules.b3GoroutineSpike.duration }}
      labels:
        severity: {{ .rules.b3GoroutineSpike.severity }}
        {{- include "b3-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: "B3 goroutine spike (instance {{`{{`}} $labels.pod {{`}}`}})"
        description: "B3 pod {{`{{`}} $labels.pod {{`}}`}} goroutine count increased by {{`{{`}} $value | printf \"%.0f\" {{`}}`}} in the last 10 minutes.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
{{- end }}
{{- end }}
{{- end }}

  # ===========================================
  # HTTP Server Alerts
  # ===========================================
{{- with .Values.form.alert.groups.http }}
{{- if (include "b3-alerts.alertGroupEnabled" (list $.Values.form.alert.enabled .)) }}
  - name: b3.http.{{ $.Release.Namespace }}.{{ $app }}.rules
    rules:
{{- if (include "b3-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.b3HighHttpErrorRate.enabled .rules.b3HighHttpErrorRate.severity)) }}
    - alert: B3HighHttpErrorRate
      expr: |
        (
          sum(rate(b3_http_server_request_count{job="{{ $job }}",namespace="{{ $.Release.Namespace }}",http_response_status_code=~"5.."}[5m]))
          /
          sum(rate(b3_http_server_request_count{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"}[5m]))
        ) * 100 > {{ .rules.b3HighHttpErrorRate.val }}
      for: {{ .rules.b3HighHttpErrorRate.duration }}
      labels:
        severity: {{ .rules.b3HighHttpErrorRate.severity }}
        {{- include "b3-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: "B3 high HTTP error rate"
        description: "B3 HTTP 5xx error rate is {{`{{`}} $value | printf \"%.2f\" {{`}}`}}%, exceeding {{ .rules.b3HighHttpErrorRate.val }}% threshold.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
{{- end }}
{{- if (include "b3-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.b3HighHttpLatency.enabled .rules.b3HighHttpLatency.severity)) }}
    - alert: B3HighHttpLatency
      expr: histogram_quantile(0.99, sum(rate(b3_http_server_request_duration_bucket{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"}[5m])) by (le)) > {{ .rules.b3HighHttpLatency.val }}
      for: {{ .rules.b3HighHttpLatency.duration }}
      labels:
        severity: {{ .rules.b3HighHttpLatency.severity }}
        {{- include "b3-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: "B3 high HTTP latency"
        description: "B3 HTTP request p99 latency is {{`{{`}} $value | printf \"%.3f\" {{`}}`}}s, exceeding {{ .rules.b3HighHttpLatency.val }}s threshold.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
{{- end }}
{{- if (include "b3-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.b3HighActiveRequests.enabled .rules.b3HighActiveRequests.severity)) }}
    - alert: B3HighActiveRequests
      expr: sum(b3_http_server_active_requests{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"}) > {{ .rules.b3HighActiveRequests.val }}
      for: {{ .rules.b3HighActiveRequests.duration }}
      labels:
        severity: {{ .rules.b3HighActiveRequests.severity }}
        {{- include "b3-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: "B3 high number of active HTTP requests"
        description: "B3 has {{`{{`}} $value {{`}}`}} active HTTP requests, exceeding {{ .rules.b3HighActiveRequests.val }} threshold.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
{{- end }}
{{- end }}
{{- end }}

  # ===========================================
  # Database Alerts
  # ===========================================
{{- with .Values.form.alert.groups.database }}
{{- if (include "b3-alerts.alertGroupEnabled" (list $.Values.form.alert.enabled .)) }}
  - name: b3.database.{{ $.Release.Namespace }}.{{ $app }}.rules
    rules:
{{- if (include "b3-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.b3HighDatabaseErrorRate.enabled .rules.b3HighDatabaseErrorRate.severity)) }}
    - alert: B3HighDatabaseErrorRate
      expr: |
        (
          sum(rate(b3_db_client_operation_count{job="{{ $job }}",namespace="{{ $.Release.Namespace }}",error="true"}[5m]))
          /
          sum(rate(b3_db_client_operation_count{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"}[5m]))
        ) * 100 > {{ .rules.b3HighDatabaseErrorRate.val }}
      for: {{ .rules.b3HighDatabaseErrorRate.duration }}
      labels:
        severity: {{ .rules.b3HighDatabaseErrorRate.severity }}
        {{- include "b3-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: "B3 high database error rate"
        description: "B3 database error rate is {{`{{`}} $value | printf \"%.2f\" {{`}}`}}%, exceeding {{ .rules.b3HighDatabaseErrorRate.val }}% threshold.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
{{- end }}
{{- if (include "b3-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.b3HighDatabaseLatency.enabled .rules.b3HighDatabaseLatency.severity)) }}
    - alert: B3HighDatabaseLatency
      expr: histogram_quantile(0.99, sum(rate(b3_db_client_operation_duration_bucket{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"}[5m])) by (le, db_system)) > {{ .rules.b3HighDatabaseLatency.val }}
      for: {{ .rules.b3HighDatabaseLatency.duration }}
      labels:
        severity: {{ .rules.b3HighDatabaseLatency.severity }}
        {{- include "b3-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: "B3 high database latency ({{`{{`}} $labels.db_system {{`}}`}})"
        description: "B3 database {{`{{`}} $labels.db_system {{`}}`}} p99 latency is {{`{{`}} $value | printf \"%.3f\" {{`}}`}}s, exceeding {{ .rules.b3HighDatabaseLatency.val }}s threshold.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
{{- end }}
{{- if (include "b3-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.b3DatabaseConnectionErrors.enabled .rules.b3DatabaseConnectionErrors.severity)) }}
    - alert: B3DatabaseConnectionErrors
      expr: sum(rate(b3_db_client_connection_error_count{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"}[5m])) * 60 > {{ .rules.b3DatabaseConnectionErrors.val }}
      for: {{ .rules.b3DatabaseConnectionErrors.duration }}
      labels:
        severity: {{ .rules.b3DatabaseConnectionErrors.severity }}
        {{- include "b3-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: "B3 database connection errors"
        description: "B3 is experiencing {{`{{`}} $value | printf \"%.2f\" {{`}}`}} database connection errors per minute, exceeding {{ .rules.b3DatabaseConnectionErrors.val }} threshold.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
{{- end }}
{{- if (include "b3-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.b3HighDatabaseConnectionPoolUsage.enabled .rules.b3HighDatabaseConnectionPoolUsage.severity)) }}
    - alert: B3HighDatabaseConnectionPoolUsage
      expr: |
        (
          sum(b3_db_connections_active{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"})
          /
          sum(b3_db_connections_limit{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"})
        ) * 100 > {{ .rules.b3HighDatabaseConnectionPoolUsage.val }}
      for: {{ .rules.b3HighDatabaseConnectionPoolUsage.duration }}
      labels:
        severity: {{ .rules.b3HighDatabaseConnectionPoolUsage.severity }}
        {{- include "b3-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: "B3 high database connection pool usage"
        description: "B3 database connection pool usage is at {{`{{`}} $value | printf \"%.2f\" {{`}}`}}%, exceeding {{ .rules.b3HighDatabaseConnectionPoolUsage.val }}% threshold.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
{{- end }}
{{- end }}
{{- end }}

  # ===========================================
  # Authentication/Authorization Alerts
  # ===========================================
{{- with .Values.form.alert.groups.auth }}
{{- if (include "b3-alerts.alertGroupEnabled" (list $.Values.form.alert.enabled .)) }}
  - name: b3.auth.{{ $.Release.Namespace }}.{{ $app }}.rules
    rules:
{{- if (include "b3-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.b3HighAuthFailureRate.enabled .rules.b3HighAuthFailureRate.severity)) }}
    - alert: B3HighAuthFailureRate
      expr: |
        (
          sum(rate(b3_auth_failures_total{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"}[5m]))
          /
          sum(rate(b3_auth_attempts_total{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"}[5m]))
        ) * 100 > {{ .rules.b3HighAuthFailureRate.val }}
      for: {{ .rules.b3HighAuthFailureRate.duration }}
      labels:
        severity: {{ .rules.b3HighAuthFailureRate.severity }}
        {{- include "b3-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: "B3 high authentication failure rate"
        description: "B3 authentication failure rate is {{`{{`}} $value | printf \"%.2f\" {{`}}`}}%, exceeding {{ .rules.b3HighAuthFailureRate.val }}% threshold.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
{{- end }}
{{- if (include "b3-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.b3HighAuthzDenialRate.enabled .rules.b3HighAuthzDenialRate.severity)) }}
    - alert: B3HighAuthzDenialRate
      expr: |
        (
          sum(rate(b3_authz_check_denied_count{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"}[5m]))
          /
          sum(rate(b3_authz_check_count{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"}[5m]))
        ) * 100 > {{ .rules.b3HighAuthzDenialRate.val }}
      for: {{ .rules.b3HighAuthzDenialRate.duration }}
      labels:
        severity: {{ .rules.b3HighAuthzDenialRate.severity }}
        {{- include "b3-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: "B3 high authorization denial rate"
        description: "B3 authorization denial rate is {{`{{`}} $value | printf \"%.2f\" {{`}}`}}%, exceeding {{ .rules.b3HighAuthzDenialRate.val }}% threshold.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
{{- end }}
{{- end }}
{{- end }}

  # ===========================================
  # Storage/BlobFS Alerts
  # ===========================================
{{- with .Values.form.alert.groups.storage }}
{{- if (include "b3-alerts.alertGroupEnabled" (list $.Values.form.alert.enabled .)) }}
  - name: b3.storage.{{ $.Release.Namespace }}.{{ $app }}.rules
    rules:
{{- if (include "b3-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.b3HighBlobStorageErrorRate.enabled .rules.b3HighBlobStorageErrorRate.severity)) }}
    - alert: B3HighBlobStorageErrorRate
      expr: |
        (
          sum(rate(b3_blobfs_operations_total{job="{{ $job }}",namespace="{{ $.Release.Namespace }}",success="false"}[5m]))
          /
          sum(rate(b3_blobfs_operations_total{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"}[5m]))
        ) * 100 > {{ .rules.b3HighBlobStorageErrorRate.val }}
      for: {{ .rules.b3HighBlobStorageErrorRate.duration }}
      labels:
        severity: {{ .rules.b3HighBlobStorageErrorRate.severity }}
        {{- include "b3-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: "B3 high blob storage error rate"
        description: "B3 blob storage error rate is {{`{{`}} $value | printf \"%.2f\" {{`}}`}}%, exceeding {{ .rules.b3HighBlobStorageErrorRate.val }}% threshold.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
{{- end }}
{{- end }}
{{- end }}

  # ===========================================
  # Proxy/K8s Operations Alerts
  # ===========================================
{{- with .Values.form.alert.groups.proxy }}
{{- if (include "b3-alerts.alertGroupEnabled" (list $.Values.form.alert.enabled .)) }}
  - name: b3.proxy.{{ $.Release.Namespace }}.{{ $app }}.rules
    rules:
{{- if (include "b3-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.b3HighProxyErrorRate.enabled .rules.b3HighProxyErrorRate.severity)) }}
    - alert: B3HighProxyErrorRate
      expr: |
        (
          sum(rate(b3_proxy_k8s_operation_total{job="{{ $job }}",namespace="{{ $.Release.Namespace }}",proxy_request_status_code=~"5.."}[5m]))
          /
          sum(rate(b3_proxy_k8s_operation_total{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"}[5m]))
        ) * 100 > {{ .rules.b3HighProxyErrorRate.val }}
      for: {{ .rules.b3HighProxyErrorRate.duration }}
      labels:
        severity: {{ .rules.b3HighProxyErrorRate.severity }}
        {{- include "b3-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: "B3 high K8s proxy error rate"
        description: "B3 K8s proxy error rate is {{`{{`}} $value | printf \"%.2f\" {{`}}`}}%, exceeding {{ .rules.b3HighProxyErrorRate.val }}% threshold.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
{{- end }}
{{- if (include "b3-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.b3HighProxyLatency.enabled .rules.b3HighProxyLatency.severity)) }}
    - alert: B3HighProxyLatency
      expr: histogram_quantile(0.99, sum(rate(b3_proxy_request_duration_bucket{job="{{ $job }}",namespace="{{ $.Release.Namespace }}"}[5m])) by (le, proxy_k8s_cluster)) > {{ .rules.b3HighProxyLatency.val }}
      for: {{ .rules.b3HighProxyLatency.duration }}
      labels:
        severity: {{ .rules.b3HighProxyLatency.severity }}
        {{- include "b3-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: "B3 high K8s proxy latency (cluster {{`{{`}} $labels.proxy_k8s_cluster {{`}}`}})"
        description: "B3 K8s proxy p99 latency for cluster {{`{{`}} $labels.proxy_k8s_cluster {{`}}`}} is {{`{{`}} $value | printf \"%.3f\" {{`}}`}}s, exceeding {{ .rules.b3HighProxyLatency.val }}s threshold.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
{{- end }}
{{- end }}
{{- end }}
{{ end }}
