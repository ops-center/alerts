{{ $app := (include "qdrant-alerts.fullname" .) }}

  {{ if (include "qdrant-alerts.alertsEnabled" .Values.form.alert.enabled) }}
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ $app }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "qdrant-alerts.labels" . | nindent 4 }}
  {{- if .Values.form.alert.labels }}
  {{- toYaml .Values.form.alert.labels | nindent 4 }}
  {{- end }}
  {{- if .Values.form.alert.annotations }}
annotations:
  {{- toYaml .Values.form.alert.annotations | nindent 4 }}
  {{- end }}
spec:
  groups:
  {{ with .Values.form.alert.groups.database -}}
  {{ if (include "qdrant-alerts.alertGroupEnabled" (list $.Values.form.alert.enabled .)) -}}
  - name: qdrant.database.{{ $.Release.Namespace }}.{{ $app }}.rules
    rules:
    {{ if (include "qdrant-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.qdrantDown.enabled .rules.qdrantDown.severity)) -}}
    - alert: QdrantDown
      expr: kubedb_com_qdrant_status_phase{app="{{ $app }}", namespace="{{ $.Release.Namespace }}",phase="NotReady"} >= 1
      for: {{ .rules.qdrantDown.duration }}
      labels:
        severity: {{ .rules.qdrantDown.severity }}
        {{- include "qdrant-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: Qdrant database is in NotReady state (instance {{`{{`}} $labels.instance {{`}}`}})
        description: "Database in NotReady state, database read/write is failing.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
    {{ if (include "qdrant-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.qdrantPhaseCritical.enabled .rules.qdrantPhaseCritical.severity)) -}}
    - alert: QdrantPhaseCritical
      expr: kubedb_com_qdrant_status_phase{app="{{ $app }}", namespace="{{ $.Release.Namespace }}",phase="Critical"} >= 1
      for: {{ .rules.qdrantPhaseCritical.duration }}
      labels:
        severity: {{ .rules.qdrantPhaseCritical.severity }}
        {{- include "qdrant-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: Qdrant database is in Critical state (instance {{`{{`}} $labels.instance {{`}}`}})
        description: "Database in Critical state, one or more database nodes are not working properly.\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
    {{ if (include "qdrant-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.qdrantClusterNoBaselineNode.enabled .rules.qdrantClusterNoBaselineNode.severity)) -}}
    - alert: QdrantClusterNoBaselineNode
      expr: cluster_TotalBaselineNodes{job=~"{{ $app }}-stats",namespace="{{ $.Release.Namespace }}"} == {{.rules.qdrantClusterNoBaselineNode.val}}
      for: {{ .rules.qdrantClusterNoBaselineNode.duration }}
      labels:
        severity: {{ .rules.qdrantClusterNoBaselineNode.severity }}
        {{- include "qdrant-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: Qdrant no baseline node (instance {{`{{`}} $labels.pod {{`}}`}})
        description: "Qdrant No Baseline Nodes on {{`{{`}} $labels.pod {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
    {{ if (include "qdrant-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.qdrantRestarted.enabled .rules.qdrantRestarted.severity)) -}}
    - alert: QdrantRestarted
      expr: (qdrant_uptime{job=~"{{ $app }}-stats",namespace="{{ $.Release.Namespace }}"}) < {{.rules.qdrantRestarted.val}}
      for: {{ .rules.qdrantRestarted.duration }}
      labels:
        severity: {{ .rules.qdrantRestarted.severity }}
        {{- include "qdrant-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: Qdrant service restart (instance {{`{{`}} $labels.pod {{`}}`}})
        description: "Qdrant service restart on {{`{{`}} $labels.pod {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
    {{ if (include "qdrant-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.qdrantHighCPULoad.enabled .rules.qdrantHighCPULoad.severity)) -}}
    - alert: QdrantHighCPULoad
      expr: (sys_CpuLoad{job=~"{{ $app }}-stats",namespace="{{ $.Release.Namespace }}"}) * 100 > {{.rules.qdrantHighCPULoad.val}}
      for: {{ .rules.qdrantHighCPULoad.duration }}
      labels:
        severity: {{ .rules.qdrantHighCPULoad.severity }}
        {{- include "qdrant-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: Qdrant System CPU High Load (instance {{`{{`}} $labels.pod {{`}}`}})
        description: "Qdrant System CPU High Load on {{`{{`}} $labels.pod {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
    {{ if (include "qdrant-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.qdrantHighHeapMemoryUsed.enabled .rules.qdrantHighHeapMemoryUsed.severity)) -}}
    - alert: QdrantHighHeapMemoryUsed
      expr:       (100 - (( sys_memory_heap_max{job=~"{{ $app }}-stats",namespace="{{ $.Release.Namespace }}"} - sys_memory_heap_used{job=~"{{ $app }}-stats",namespace="{{ $.Release.Namespace }}"}) * 100 / sys_memory_heap_max{job=~"{{ $app }}-stats",namespace="{{ $.Release.Namespace }}"})) > {{.rules.qdrantHighHeapMemoryUsed.val}}
      for: {{ .rules.qdrantHighHeapMemoryUsed.duration }}
      labels:
        severity: {{ .rules.qdrantHighHeapMemoryUsed.severity }}
        {{- include "qdrant-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: Qdrant High System Heap Memory Used (instance {{`{{`}} $labels.pod {{`}}`}})
        description: "Qdrant High System Heap Memory Used on {{`{{`}} $labels.pod {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
    {{ if (include "qdrant-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.qdrantHighDataregionOffHeapUsed.enabled .rules.qdrantHighDataregionOffHeapUsed.severity)) -}}
    - alert: QdrantHighDataregionOffHeapUsed
      expr: ((io_dataregion_default_OffheapUsedSize{job=~"{{ $app }}-stats",namespace="{{ $.Release.Namespace }}"}) / 1024 / 1024 / 1024)  * 100 > {{.rules.qdrantHighDataregionOffHeapUsed.val}}
      for: {{ .rules.qdrantHighDataregionOffHeapUsed.duration }}
      labels:
        severity: {{ .rules.qdrantHighDataregionOffHeapUsed.severity }}
        {{- include "qdrant-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: Qdrant High default Dataregion Off Heap Memory Used (instance {{`{{`}} $labels.pod {{`}}`}})
        description: "Qdrant High default Dataregion Off Heap Memory Used on {{`{{`}} $labels.pod {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
    {{ if (include "qdrant-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.qdrantJVMPausesTotalDuration.enabled .rules.qdrantJVMPausesTotalDuration.severity)) -}}
    - alert: QdrantJVMPausesTotalDuration
      expr: (qdrant_longJVMPausesTotalDuration{job=~"{{ $app }}-stats",namespace="{{ $.Release.Namespace }}"}) * 100 > {{.rules.qdrantJVMPausesTotalDuration.val}}
      for: {{ .rules.qdrantJVMPausesTotalDuration.duration }}
      labels:
        severity: {{ .rules.qdrantJVMPausesTotalDuration.severity }}
        {{- include "qdrant-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: Qdrant JVM Pauses Total Duration (instance {{`{{`}} $labels.pod {{`}}`}})
        description: "Qdrant JVM Pauses Total Duration on {{`{{`}} $labels.pod {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
    {{ if (include "qdrant-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.diskUsageHigh.enabled .rules.diskUsageHigh.severity)) -}}
    - alert: DiskUsageHigh
      expr: (kubelet_volume_stats_used_bytes{service="kubernetes"} / on(persistentvolumeclaim) group_left(pod) ((kubelet_volume_stats_used_bytes{service="kubernetes"} + on(persistentvolumeclaim) group_left(pod) kube_pod_spec_volumes_persistentvolumeclaims_info{pod=~"{{ $.Release.Name }}-.+$",namespace=~"{{ $.Release.Namespace }}"}) ) )
        * 100 > {{ .rules.diskUsageHigh.val }}
      for: {{ .rules.diskUsageHigh.duration }}
      labels:
        severity: {{ .rules.diskUsageHigh.severity }}
        {{- include "qdrant-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: Persistent Volume Usages in instance {{`{{`}} $labels.instance {{`}}`}}
        description: "Persistent Volume Usages\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
    {{ if (include "qdrant-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.diskAlmostFull.enabled .rules.diskAlmostFull.severity)) -}}
    - alert: DiskAlmostFull
      expr: (kubelet_volume_stats_used_bytes{service="kubernetes"} / on(persistentvolumeclaim) group_left(pod) ((kubelet_volume_stats_used_bytes{service="kubernetes"} + on(persistentvolumeclaim) group_left(pod) kube_pod_spec_volumes_persistentvolumeclaims_info{pod=~"{{ $.Release.Name }}-.+$",namespace=~"{{ $.Release.Namespace }}"}) ) )
        * 100 > {{ .rules.diskAlmostFull.val }}
      for: {{ .rules.diskAlmostFull.duration }}
      labels:
        severity: {{ .rules.diskAlmostFull.severity }}
        {{- include "qdrant-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: Persistent Volume Usages in instance {{`{{`}} $labels.instance {{`}}`}}
        description: "Persistent Volume Usages\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
  {{end -}}
  {{end -}}


  {{ with .Values.form.alert.groups.provisioner -}}
  {{ if (include "qdrant-alerts.alertGroupEnabled" (list $.Values.form.alert.enabled .)) -}}
  - name: qdrant.provisioner.{{ $.Release.Namespace }}.{{ $app }}.rules
    rules:
    {{ if (include "qdrant-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.appPhaseNotReady.enabled .rules.appPhaseNotReady.severity)) -}}
    - alert: KubeDBQdrantPhaseNotReady
      expr: kubedb_com_qdrant_status_phase{phase="NotReady",app="{{ $app }}",namespace="{{ $.Release.Namespace }}"} == 1
      for: {{ .rules.appPhaseNotReady.duration }}
      labels:
        severity: {{ .rules.appPhaseNotReady.severity }}
        {{- include "qdrant-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: KubeDB Qdrant Phase NotReady (qdrant {{`{{`}} $labels.qdrant {{`}}`}})
        description: "KubeDB Qdrant Phase not ready on {{`{{`}} $labels.qdrant {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{ end -}}
    {{ if (include "qdrant-alerts.alertEnabled" (list $.Values.form.alert.enabled .enabled .rules.appPhaseCritical.enabled .rules.appPhaseCritical.severity)) -}}
    - alert: KubeDBQdrantPhaseCritical
      expr: kubedb_com_qdrant_status_phase{phase="Critical",app="{{ $app }}",namespace="{{ $.Release.Namespace }}"} == 1
      for: {{ .rules.appPhaseCritical.duration }}
      labels:
        severity: {{ .rules.appPhaseCritical.severity }}
        {{- include "qdrant-alerts.alertLabels" $ | nindent 8 }}
      annotations:
        summary: KubeDB Qdrant Phase Critical (qdrant {{`{{`}} $labels.qdrant {{`}}`}})
        description: "KubeDB Qdrant Phase Critical {{`{{`}} $labels.qdrant {{`}}`}}\n  VALUE = {{`{{`}} $value {{`}}`}}\n  LABELS = {{`{{`}} $labels {{`}}`}}"
    {{- end }}
  {{ end -}}
  {{ end -}}

  {{ end }}
